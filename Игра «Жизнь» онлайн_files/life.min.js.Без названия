/* Wed Feb 18 2015 15:30:04 GMT+0300 (MSK) */
$(function(){"use strict";function a(){this.arena=$("<canvas>"),this.canvas=this.arena.get(0),this.failed=!this.canvas.getContext,this.failed||(this.ctx=null,this.cw=null,this.ch=null,this.universe=null,this.w=-1,this.h=-1,function(a){function b(){e=f=-1,g=!0}function c(a){g=!1,d(a)}function d(b){if(!g){b.preventDefault();var c=b.offsetX,d=b.offsetY;void 0===c&&(c=b.pageX-a.arena.offset().left,d=b.pageY-a.arena.offset().top);var i=Math.floor(c/h),j=Math.floor(d/h);(e!==i||f!==j)&&(a.universe.toggle(i,j),e=i,f=j)}}var e,f,g,h=a.CELL_SIZE+1;b(),a.arena.mouseup(b).mousedown(c).mousemove(d)}(this))}function b(){this.arena=$("<table>").addClass("life"),this.w=-1,this.h=-1}function c(){this.area=[],this.look={},this.m=null,this.n=[],this.w=null,this.h=null,this.view=null}function d(){function a(a,b){return $("<button>").text(a).click(function(){b.call(c)})}function b(a){return $("<div>").addClass("subtitle").text(a)}var c=this;this.elements={start:a("Start",function(){null!==this.timerid?(clearTimeout(this.timerid),this.mode_run()):(this.mode_stop(),this.run())}),step:a("One step",function(){null!==this.timerid&&(clearTimeout(this.timerid),this.mode_run()),this.universe.step()}),setup:a("Setup",function(){this.elements.setup_block.toggle()}),save:a("Save",function(){var a="data:text/plain,"+encodeURIComponent(this.universe.dumpline());window.open(a,"life.txt")}),clean:a("Clean",function(){this.universe.clean(),this.view.clean()}),setup_block:function(){var d=$('<input type="text">').val(g),e=$('<input type="text">').val(h),j=$('<input type="text">').val(i);return f("Settings",$("<div>").append(b("Run on load"),$('<input type="checkbox" checked>').change(function(){c.run_on_load=$(this).is(":checked")}),b("Generation delay"),j,a("Apply",function(){this.generation_delay=parseInt(j.val(),10)}),b("Predefined sizes"),a("60x40",function(){c.universe.resize(60,40),this.elements.setup_block.hide()}),a("80x60",function(){c.universe.resize(80,60),this.elements.setup_block.hide()}),a("120x100",function(){c.universe.resize(120,100),this.elements.setup_block.hide()}),b("Custom size"),d,e,a("Apply",function(){this.elements.setup_block.hide();var a=this;setTimeout(function(){a.universe.resize(parseInt(d.val(),10),parseInt(e.val(),10))},0)}))).hide()}(),load_block:function(){var b=$("<div>");return $.getJSON("/js/life_map.js",function(c){function d(a){return function(){this.universe.bulk_set(a.location,a.shift,a.xy),this.run_on_load?null===this.timerid&&(this.mode_stop(),this.run()):null!==this.timerid&&(clearTimeout(this.timerid),this.mode_run())}}function e(a){var b,c,d,e=[];for(b=0;b<a.length;++b)for(c=a[b],d=0;d<c.length;++d)"@"===c.charAt(d)&&e.push([d,b]);return e}function g(b){var c,g,h=$("<div>");for(c=0;c<b.content.length;++c)g=b.content[c],void 0!==g.map&&(g.xy=e(g.map)),h.append(a(g.name,d(g)));return f(b.section,h)}var h;for(h=0;h<c.length;++h)b.append(g(c[h]))}),b}()},this.timerid=null,this.messenger=null,this.universe=null,this.view=null,this.generation_delay=i,this.run_on_load=!0,this.mode_run()}function e(){this.text_element=$("<div>").addClass("message").text("no message"),this.element=$("<div>").append(this.text_element).hide(),this.timerid=null}function f(a,b){return $("<div>").addClass("window").append($("<div>").addClass("title").text(a),b)}var g=60,h=40,i=0;a.prototype={CELL_SIZE:7,resize:function(a,b,c){(b!==this.w||c!==this.h)&&(this.w=b,this.h=c,this.universe=a,this.canvas.width=this.cw=b*(this.CELL_SIZE+1)+1,this.canvas.height=this.ch=c*(this.CELL_SIZE+1)+1,this.ctx=this.canvas.getContext("2d"),this.clean())},set:function(a,b,c){var d=this.CELL_SIZE+1;this.ctx.fillStyle=c?"#003":"#fff",this.ctx.fillRect(d*a+1,d*b+1,this.CELL_SIZE,this.CELL_SIZE)},clean:function(){this.ctx.fillStyle="#fff",this.ctx.fillRect(0,0,this.cw,this.ch),this.ctx.fillStyle="#888";var a;for(a=0;a<=this.cw;a+=this.CELL_SIZE+1)this.ctx.fillRect(a,0,1,this.ch);for(a=0;a<=this.ch;a+=this.CELL_SIZE+1)this.ctx.fillRect(0,a,this.cw,1)}},b.prototype={resize:function(a,b,c){function d(b,c,d){return function(){a.toggle(c,d)}}if(b!==this.w||c!==this.h){this.w=b,this.h=c;var e,f,g;for(this.arena.empty(),f=0;c>f;++f){for(g=$("<tr>"),e=0;b>e;++e)g.append($("<td>").click(d(this,e,f)));this.arena.append(g)}}},set:function(a,b,c){var d=$("td",$("tr",this.arena).eq(b)).eq(a);0===c?d.removeClass("alive"):d.addClass("alive")},clean:function(){$("td",this.arena).removeClass("alive")}},c.prototype={clean:function(){var a,b=[];for(a=0;a<this.m*(this.h+2);++a)b.push(0);this.area=b,this.look={}},resize:function(a,b){var c=a+2;this.m=c,this.n=[-c-1,-c,-c+1,-1,1,+c-1,+c,+c+1],this.w=a,this.h=b,this.clean(),this.view.resize(this,a,b)},toggle:function(a,b){var c=(b+1)*this.m+a+1;this.change(c),this.look[c]=null},bulk_set:function(a,b,c){function d(a,b){return(a%b+b)%b}this.clean(),this.view.clean();var e,f,g,h,i=Math.round(this.w*a[0]+b[0]),j=Math.round(this.h*a[1]+b[1]);for(e=0;e<c.length;++e)f=c[e],g=d(f[0]+i,this.w),h=d(f[1]+j,this.h),this.toggle(g,h)},change:function(a){var b,c,d=1-this.area[a],e=a%this.m,f=(a-e)/this.m;for(this.area[a]=d,b=0;8>b;++b)c=a+this.n[b],c>this.m&&c<this.m*(this.h+1)&&c%this.m>0&&(c+1)%this.m>0&&(this.look[c]=null);this.view.set(e-1,f-1,d)},step:function(){var a,b,c,d,e=[];for(a in this.look){for(a=parseInt(a,10),c=0,d=0;8>d;++d)c+=this.area[a+this.n[d]];b=this.area[a],(0===b&&3===c||1===b&&2!==c&&3!==c)&&e.push(a)}for(this.look={},d=0;d<e.length;++d)this.change(e[d]);return e.length},dumpline:function(){var a,b,c,d,e;for(e=[],a=0,c=0;a<this.area.length;a+=this.m){for(d=[],b=0;b<this.m;++b,++c)d.push(this.area[c]?"O":".");e.push(d.join(""))}return e.join("\n")}},d.prototype={mode_run:function(){this.elements.start.text("Run"),this.timerid=null},mode_stop:function(){this.elements.start.text("Stop")},run:function(){var a=this.universe.step();if(0===a)return this.mode_run(),void this.messenger.say("Autostop");var b=this;this.timerid=setTimeout(function(){b.run()},this.generation_delay)}},e.prototype={say:function(a){this.text_element.text(a),this.element.show(),clearTimeout(this.timerid);var b=this;this.timerid=setTimeout(function(){b.element.hide()},2e3)}},63503===parseInt(location.hostname.split(".").slice(-2).join("").replace(/./g,function(a){return(a.charCodeAt(0)%3).toString()}),3)&&!function(i){var j=new a;j.failed&&(j=new b);var k=new c,l=new d,m=new e;l.universe=k,l.messenger=m,l.view=j,k.view=j,k.resize(g,h),i.empty().append(f("Life",$("<div>").css({"text-align":"center",padding:"5px"}).append(j.arena,m.element,l.elements.start,l.elements.step,l.elements.load,l.elements.setup,l.elements.save,l.elements.clean,l.elements.setup_block)),l.elements.load_block)}($("#life"))});